<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Productos - Panel Usuario</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="/src/css/styles.css">
</head>

<body>

  <nav class="topbar" id="app-topbar"></nav>

  <div class="app-container">
    <aside class="sidebar" id="app-sidebar-user"></aside>

    <main class="main-content">
      <div class="container-fluid">

        <div class="d-flex justify-content-between align-items-center mb-3">
          <div>
            <h2 class="fw-bold text-primary mb-0">
              <i class="bi bi-box-seam me-2"></i>Productos
            </h2>
            <p class="text-muted mb-0">Consulta el inventario de equipos y activos</p>
          </div>
          <a href="panel.html" class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-arrow-left"></i> Volver al panel
          </a>
        </div>

        <!-- Filtros -->
        <div class="card shadow-sm border-0 mb-4">
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-3">
                <input type="text" id="inputBuscar" class="form-control" placeholder="Buscar por modelo o serial...">
              </div>
              <div class="col-md-3">
                <select id="filtroCategoria" class="form-select">
                  <option value="">Categoría: Todas</option>
                </select>
              </div>
              <div class="col-md-3">
                <select id="filtroSucursal" class="form-select">
                  <option value="">Sucursal: Todas</option>
                </select>
              </div>
              <div class="col-md-3">
                <select id="filtroEstado" class="form-select">
                  <option value="">Estado: Todos</option>
                </select>
              </div>
            </div>
          </div>
        </div>

        <!-- Vista de tarjetas -->
        <div id="vistaCards" class="row g-4" style="min-height: 400px;">
          <div class="col-12 text-center">
            <div class="spinner-border text-primary mt-5" role="status">
              <span class="visually-hidden">Cargando...</span>
            </div>
          </div>
        </div>

        <footer class="text-center mt-4 small text-muted">
          © 2025 Grupo Coyahue — Sistema de Inventario
        </footer>

      </div>
    </main>
  </div>

  <!-- Modal Detalle -->
  <div class="modal fade" id="modalDetalle" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="bi bi-box-seam me-2"></i>
            <span id="modalTitulo">Detalle del Producto</span>
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="modalContenido">
          <!-- Se llenará dinámicamente -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script type="module">
    import { API } from "/src/js/api.js";

    let productosCache = [];

    function cargarSidebarUsuario() {
      const sidebar = document.getElementById("app-sidebar-user");
      if (!sidebar) return;

      sidebar.innerHTML = `
        <img src="/src/img/logo-coyahue.png" alt="Logo Coyahue" class="logo" />
        <nav>
          <a class="nav-link" href="panel.html">
            <i class="bi bi-house-door"></i> Inicio
          </a>
          <a class="nav-link active" href="productos-usuario.html">
            <i class="bi bi-box-seam"></i> Productos
          </a>
          <a class="nav-link" href="categorias-usuario.html">
            <i class="bi bi-tags"></i> Categorías
          </a>
          <a class="nav-link" href="proveedores-usuario.html">
            <i class="bi bi-truck"></i> Proveedores
          </a>
          <a class="nav-link" href="sucursales-usuario.html">
            <i class="bi bi-geo-alt"></i> Sucursales
          </a>
          <a class="nav-link" href="reportes-usuario.html">
            <i class="bi bi-graph-up"></i> Reportes
          </a>
          <a class="nav-link" href="/paginas/ajustes/ajustes.html">
            <i class="bi bi-gear"></i> Ajustes
          </a>
        </nav>
      `;
    }

    function cargarTopbarUsuario() {
      const topbar = document.getElementById("app-topbar");
      if (!topbar) return;

      const usuarioLog = localStorage.getItem("username") || "Usuario";

      topbar.innerHTML = `
        <div class="d-flex align-items-center gap-2">
          <button class="btn btn-link text-white d-lg-none p-0 me-2 menu-toggle" type="button">
            <i class="bi bi-list fs-3"></i>
          </button>
        </div>

        <div class="flex-grow-1"></div>

        <div class="d-flex align-items-center gap-3">
          <span id="btn-dark-toggle" class="toggle-dark" role="button">
            <i class="bi bi-moon-stars-fill" id="dark-icon"></i>
          </span>

          <div class="dropdown">
            <button class="btn btn-sm btn-outline-light dropdown-toggle user-area"
                    type="button" data-bs-toggle="dropdown">
              ${usuarioLog}
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item" href="/paginas/ajustes/ajustes.html">Ajustes</a></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item" onclick="window.cerrarSesion()">Cerrar sesión</a></li>
            </ul>
          </div>
        </div>
      `;
    }

    function normalizarLista(res) {
      if (Array.isArray(res)) return res;
      if (res && Array.isArray(res.results)) return res.results;
      return [];
    }

    function getNombreCampo(campo, fallback = "—") {
      if (campo === null || campo === undefined) return fallback;
      if (typeof campo === "object") {
        if (campo.nombre) return campo.nombre;
        return JSON.stringify(campo);
      }
      return campo;
    }

    async function cargarProductos() {
      try {
        const res = await API.get("productos/");
        productosCache = normalizarLista(res);
        
        poblarFiltros();
        renderProductos(productosCache);
      } catch (err) {
        console.error("Error al cargar productos:", err);
        document.getElementById("vistaCards").innerHTML = `
          <div class="col-12 text-center text-danger">
            <i class="bi bi-exclamation-circle fs-1"></i>
            <p class="mt-2">No se pudieron cargar los productos.</p>
          </div>
        `;
      }
    }

    function poblarFiltros() {
      const cats = [...new Set(
        productosCache.map(p => 
          p.categoria_nombre || getNombreCampo(p.categoria, null)
        ).filter(Boolean)
      )];

      const sucs = [...new Set(
        productosCache.map(p =>
          p.sucursal_nombre || getNombreCampo(p.sucursal, null)
        ).filter(Boolean)
      )];

      const ests = [...new Set(
        productosCache.map(p =>
          p.estado_nombre || getNombreCampo(p.estado, null)
        ).filter(Boolean)
      )];

      const filtroCategoria = document.getElementById("filtroCategoria");
      const filtroSucursal = document.getElementById("filtroSucursal");
      const filtroEstado = document.getElementById("filtroEstado");

      if (filtroCategoria) {
        filtroCategoria.innerHTML = `<option value="">Categoría: Todas</option>` +
          cats.map(c => `<option value="${c}">${c}</option>`).join("");
      }

      if (filtroSucursal) {
        filtroSucursal.innerHTML = `<option value="">Sucursal: Todas</option>` +
          sucs.map(s => `<option value="${s}">${s}</option>`).join("");
      }

      if (filtroEstado) {
        filtroEstado.innerHTML = `<option value="">Estado: Todos</option>` +
          ests.map(e => `<option value="${e}">${e}</option>`).join("");
      }
    }

    function aplicarFiltros() {
      const texto = (document.getElementById("inputBuscar")?.value || "").toLowerCase();
      const cat = document.getElementById("filtroCategoria")?.value || "";
      const suc = document.getElementById("filtroSucursal")?.value || "";
      const est = document.getElementById("filtroEstado")?.value || "";

      const filtrados = productosCache.filter(p => {
        const categoriaTexto = p.categoria_nombre || getNombreCampo(p.categoria, "");
        const sucursalTexto = p.sucursal_nombre || getNombreCampo(p.sucursal, "");
        const estadoTexto = p.estado_nombre || getNombreCampo(p.estado, "");

        const nombreProd = p.modelo_nombre ? `${p.modelo_nombre} - ${p.nro_serie}` : p.nro_serie;

        const coincideTexto = !texto ||
          (nombreProd || "").toLowerCase().includes(texto) ||
          (p.nro_serie || "").toLowerCase().includes(texto);

        const coincideCat = !cat || categoriaTexto === cat;
        const coincideSuc = !suc || sucursalTexto === suc;
        const coincideEst = !est || estadoTexto === est;

        return coincideTexto && coincideCat && coincideSuc && coincideEst;
      });

      renderProductos(filtrados);
    }

    function renderProductos(lista) {
      const cont = document.getElementById("vistaCards");
      if (!cont) return;

      if (!lista.length) {
        cont.innerHTML = `
          <div class="col-12 text-center text-muted">
            <i class="bi bi-inbox fs-1"></i>
            <p class="mt-2">No hay productos que coincidan con los filtros.</p>
          </div>
        `;
        return;
      }

      cont.innerHTML = "";

      lista.forEach(p => {
        const col = document.createElement("div");
        col.className = "col-md-4 col-lg-3";

        const nombreProd = p.modelo_nombre ? `${p.modelo_nombre}` : p.nro_serie;
        const categoriaTexto = p.categoria_nombre || getNombreCampo(p.categoria, "Sin categoría");
        const sucursalTexto = p.sucursal_nombre || getNombreCampo(p.sucursal, "Sin sucursal");
        const estadoTexto = p.estado_nombre || getNombreCampo(p.estado, "—");
        const garantiaValor = p.garantia_meses ?? p.garantia ?? null;
        const garantiaTexto = garantiaValor === null || garantiaValor === "" ? "—" : `${garantiaValor} meses`;

        col.innerHTML = `
          <div class="card h-100 p-3 text-center" style="cursor:pointer;" onclick="verDetalle(${p.id})">
            <div class="mb-2">
              <i class="bi bi-box-seam fs-1 text-primary"></i>
            </div>
            <h6 class="fw-bold mb-1">${nombreProd}</h6>
            <small class="text-muted d-block mb-2">${p.nro_serie}</small>
            <span class="badge bg-light text-dark mb-2">${categoriaTexto}</span>
            <p class="small mb-1"><strong>Sucursal:</strong> ${sucursalTexto}</p>
            <p class="small mb-1"><strong>Estado:</strong> ${estadoTexto}</p>
            <p class="small mb-0"><strong>Garantía:</strong> ${garantiaTexto}</p>
          </div>
        `;

        cont.appendChild(col);
      });
    }

    window.verDetalle = async function(id) {
      const modal = new bootstrap.Modal(document.getElementById('modalDetalle'));
      const titulo = document.getElementById('modalTitulo');
      const contenido = document.getElementById('modalContenido');

      titulo.textContent = "Cargando...";
      contenido.innerHTML = '<div class="text-center"><div class="spinner-border"></div></div>';
      modal.show();

      try {
        const p = await API.get(`productos/${id}/`);

        const nombreProd = p.modelo_nombre ? `${p.modelo_nombre} - ${p.nro_serie}` : p.nro_serie;
        titulo.textContent = nombreProd;

        const categoriaTexto = p.categoria_nombre || getNombreCampo(p.categoria, "—");
        const sucursalTexto = p.sucursal_nombre || getNombreCampo(p.sucursal, "—");
        const estadoTexto = p.estado_nombre || getNombreCampo(p.estado, "—");
        const garantiaValor = p.garantia_meses ?? p.garantia ?? null;
        const garantiaTexto = garantiaValor === null ? "—" : `${garantiaValor} meses`;

        contenido.innerHTML = `
          <div class="row">
            <div class="col-md-6">
              <p><strong>Nro. de serie:</strong><br>${p.nro_serie || "—"}</p>
              <p><strong>Categoría:</strong><br>${categoriaTexto}</p>
              <p><strong>Sucursal:</strong><br>${sucursalTexto}</p>
              <p><strong>Estado:</strong><br>${estadoTexto}</p>
            </div>
            <div class="col-md-6">
              <p><strong>Fecha de compra:</strong><br>${p.fecha_compra || "—"}</p>
              <p><strong>Garantía:</strong><br>${garantiaTexto}</p>
              <p><strong>Factura:</strong><br>${p.documento_factura || "—"}</p>
            </div>
          </div>
        `;

      } catch (err) {
        console.error("Error al cargar detalle:", err);
        contenido.innerHTML = '<p class="text-danger">No se pudo cargar el detalle del producto.</p>';
      }
    };

    window.cerrarSesion = function() {
      localStorage.clear();
      window.location.href = "/paginas/login/login.html";
    };

    function configurarTema() {
      const body = document.body;
      const toggle = document.getElementById("btn-dark-toggle");
      const icon = document.getElementById("dark-icon");
      if (!toggle || !icon) return;

      const temaGuardado = localStorage.getItem("theme") || "light";
      if (temaGuardado === "dark") {
        body.classList.add("dark-mode");
        icon.classList.replace("bi-moon-stars-fill", "bi-brightness-high-fill");
      }

      toggle.addEventListener("click", () => {
        const esDark = body.classList.toggle("dark-mode");
        icon.classList.toggle("bi-moon-stars-fill", !esDark);
        icon.classList.toggle("bi-brightness-high-fill", esDark);
        localStorage.setItem("theme", esDark ? "dark" : "light");
      });
    }

    document.addEventListener("DOMContentLoaded", () => {
      cargarTopbarUsuario();
      cargarSidebarUsuario();
      configurarTema();
      cargarProductos();

      // Event listeners para filtros
      document.getElementById("inputBuscar")?.addEventListener("input", aplicarFiltros);
      document.getElementById("filtroCategoria")?.addEventListener("change", aplicarFiltros);
      document.getElementById("filtroSucursal")?.addEventListener("change", aplicarFiltros);
      document.getElementById("filtroEstado")?.addEventListener("change", aplicarFiltros);
    });
  </script>

</body>
</html>