<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sucursales - Panel Usuario</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="/src/css/styles.css">
</head>

<body>

  <nav class="topbar" id="app-topbar"></nav>

  <div class="app-container">
    <aside class="sidebar" id="app-sidebar-user"></aside>

    <main class="main-content">
      <div class="container-fluid">

        <div class="d-flex justify-content-between align-items-center mb-3">
          <div>
            <h2 class="fw-bold text-primary mb-0">
              <i class="bi bi-geo-alt me-2"></i>Sucursales
            </h2>
            <p class="text-muted mb-0">Ubicaciones del Grupo Coyahue</p>
          </div>
          <a href="panel.html" class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-arrow-left"></i> Volver al panel
          </a>
        </div>

        <!-- Filtros -->
        <div class="card shadow-sm border-0 mb-4">
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-6">
                <input type="text" id="inputBuscar" class="form-control" placeholder="Buscar sucursal...">
              </div>
            </div>
          </div>
        </div>

        <!-- Vista de tarjetas -->
        <div id="vistaCards" class="row g-4" style="min-height: 400px;">
          <div class="col-12 text-center">
            <div class="spinner-border text-primary mt-5" role="status">
              <span class="visually-hidden">Cargando...</span>
            </div>
          </div>
        </div>

        <footer class="text-center mt-4 small text-muted">
          © 2025 Grupo Coyahue — Sistema de Inventario
        </footer>

      </div>
    </main>
  </div>

  <!-- Modal Detalle -->
  <div class="modal fade" id="modalDetalle" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-info text-white">
          <h5 class="modal-title">
            <i class="bi bi-geo-alt me-2"></i>
            <span id="modalTitulo">Detalle de Sucursal</span>
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="modalContenido">
          <!-- Se llenará dinámicamente -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script type="module">
    import { API } from "/src/js/api.js";

    let sucursalesCache = [];

    function cargarSidebarUsuario() {
      const sidebar = document.getElementById("app-sidebar-user");
      if (!sidebar) return;

      sidebar.innerHTML = `
        <img src="/src/img/logo-coyahue.png" alt="Logo Coyahue" class="logo" />
        <nav>
          <a class="nav-link" href="panel.html">
            <i class="bi bi-house-door"></i> Inicio
          </a>
          <a class="nav-link" href="productos-usuario.html">
            <i class="bi bi-box-seam"></i> Productos
          </a>
          <a class="nav-link" href="categorias-usuario.html">
            <i class="bi bi-tags"></i> Categorías
          </a>
          <a class="nav-link" href="proveedores-usuario.html">
            <i class="bi bi-truck"></i> Proveedores
          </a>
          <a class="nav-link active" href="sucursales-usuario.html">
            <i class="bi bi-geo-alt"></i> Sucursales
          </a>
          <a class="nav-link" href="reportes-usuario.html">
            <i class="bi bi-graph-up"></i> Reportes
          </a>
          <a class="nav-link" href="/paginas/usuario/ajustes-usuario.html">
            <i class="bi bi-gear"></i> Ajustes
          </a>
        </nav>
      `;
    }

    function cargarTopbarUsuario() {
      const topbar = document.getElementById("app-topbar");
      if (!topbar) return;

      const usuarioLog = localStorage.getItem("username") || "Usuario";

      topbar.innerHTML = `
        <div class="d-flex align-items-center gap-2">
          <button class="btn btn-link text-white d-lg-none p-0 me-2 menu-toggle" type="button">
            <i class="bi bi-list fs-3"></i>
          </button>
        </div>
        <div class="flex-grow-1"></div>
        <div class="d-flex align-items-center gap-3">
          <span id="btn-dark-toggle" class="toggle-dark" role="button">
            <i class="bi bi-moon-stars-fill" id="dark-icon"></i>
          </span>
          <div class="dropdown">
            <button class="btn btn-sm btn-outline-light dropdown-toggle user-area"
                    type="button" data-bs-toggle="dropdown">
              ${usuarioLog}
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item" href="/paginas/ajustes/ajustes.html">Ajustes</a></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item" onclick="window.cerrarSesion()">Cerrar sesión</a></li>
            </ul>
          </div>
        </div>
      `;
    }

    function normalizarLista(res) {
      if (Array.isArray(res)) return res;
      if (res && Array.isArray(res.results)) return res.results;
      return [];
    }

    async function cargarSucursales() {
      try {
        const res = await API.get("sucursales/");
        sucursalesCache = normalizarLista(res);
        renderSucursales(sucursalesCache);
      } catch (err) {
        console.error("Error al cargar sucursales:", err);
        document.getElementById("vistaCards").innerHTML = `
          <div class="col-12 text-center text-danger">
            <i class="bi bi-exclamation-circle fs-1"></i>
            <p class="mt-2">No se pudieron cargar las sucursales.</p>
          </div>
        `;
      }
    }

    function aplicarFiltros() {
      const texto = (document.getElementById("inputBuscar")?.value || "").toLowerCase();

      const filtradas = sucursalesCache.filter(s => {
        const nombre = (s.nombre || "").toLowerCase();
        return nombre.includes(texto);
      });

      renderSucursales(filtradas);
    }

    function renderSucursales(lista) {
      const cont = document.getElementById("vistaCards");
      if (!cont) return;

      if (!lista.length) {
        cont.innerHTML = `
          <div class="col-12 text-center text-muted">
            <i class="bi bi-inbox fs-1"></i>
            <p class="mt-2">No hay sucursales que coincidan con la búsqueda.</p>
          </div>
        `;
        return;
      }

      cont.innerHTML = "";

      lista.forEach(s => {
        const col = document.createElement("div");
        col.className = "col-md-6 col-lg-4";

        col.innerHTML = `
          <div class="card h-100 p-4" style="cursor:pointer;" onclick="verDetalle(${s.id})">
            <div class="text-center mb-3">
              <div style="width:60px;height:60px;border-radius:50%;background:#0dcaf0;display:flex;align-items:center;justify-content:center;margin:0 auto;">
                <i class="bi bi-geo-alt fs-2 text-white"></i>
              </div>
            </div>
            <h6 class="fw-bold text-center mb-2">${s.nombre || "Sin nombre"}</h6>
            <p class="small text-muted text-center mb-1">
              <i class="bi bi-signpost-2 text-info me-1"></i>
              ${s.direccion || "Sin dirección"}
            </p>
            <p class="small text-muted text-center mb-0">
              <i class="bi bi-telephone text-info me-1"></i>
              ${s.telefono || "Sin teléfono"}
            </p>
          </div>
        `;

        cont.appendChild(col);
      });
    }

    window.verDetalle = async function(id) {
      const modal = new bootstrap.Modal(document.getElementById('modalDetalle'));
      const titulo = document.getElementById('modalTitulo');
      const contenido = document.getElementById('modalContenido');

      titulo.textContent = "Cargando...";
      contenido.innerHTML = '<div class="text-center"><div class="spinner-border text-info"></div></div>';
      modal.show();

      try {
        const s = await API.get(`sucursales/${id}/`);

        titulo.textContent = s.nombre || "Sin nombre";

        contenido.innerHTML = `
          <div class="row">
            <div class="col-md-6">
              <p><strong>ID:</strong><br>${s.id}</p>
              <p><strong>Nombre:</strong><br>${s.nombre || "—"}</p>
            </div>
            <div class="col-md-6">
              <p><strong>Dirección:</strong><br>${s.direccion || "—"}</p>
              <p><strong>Teléfono:</strong><br>${s.telefono || "—"}</p>
            </div>
          </div>
        `;

      } catch (err) {
        console.error("Error al cargar detalle:", err);
        contenido.innerHTML = '<p class="text-danger">No se pudo cargar el detalle de la sucursal.</p>';
      }
    };

    window.cerrarSesion = function() {
      localStorage.clear();
      window.location.href = "/paginas/login/login.html";
    };

    function configurarTema() {
      const body = document.body;
      const toggle = document.getElementById("btn-dark-toggle");
      const icon = document.getElementById("dark-icon");
      if (!toggle || !icon) return;

      const temaGuardado = localStorage.getItem("theme") || "light";
      if (temaGuardado === "dark") {
        body.classList.add("dark-mode");
        icon.classList.replace("bi-moon-stars-fill", "bi-brightness-high-fill");
      }

      toggle.addEventListener("click", () => {
        const esDark = body.classList.toggle("dark-mode");
        icon.classList.toggle("bi-moon-stars-fill", !esDark);
        icon.classList.toggle("bi-brightness-high-fill", esDark);
        localStorage.setItem("theme", esDark ? "dark" : "light");
      });
    }

    document.addEventListener("DOMContentLoaded", () => {
      cargarTopbarUsuario();
      cargarSidebarUsuario();
      configurarTema();
      cargarSucursales();

      document.getElementById("inputBuscar")?.addEventListener("input", aplicarFiltros);
    });
  </script>

</body>
</html>