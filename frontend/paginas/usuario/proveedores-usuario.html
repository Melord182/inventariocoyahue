<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Proveedores - Panel Usuario</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="/src/css/styles.css">
</head>

<body>

  <nav class="topbar" id="app-topbar"></nav>

  <div class="app-container">
    <aside class="sidebar" id="app-sidebar-user"></aside>

    <main class="main-content">
      <div class="container-fluid">

        <div class="d-flex justify-content-between align-items-center mb-3">
          <div>
            <h2 class="fw-bold text-primary mb-0">
              <i class="bi bi-truck me-2"></i>Proveedores
            </h2>
            <p class="text-muted mb-0">Información de proveedores registrados</p>
          </div>
          <a href="panel.html" class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-arrow-left"></i> Volver al panel
          </a>
        </div>

        <!-- Filtros -->
        <div class="card shadow-sm border-0 mb-4">
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-4">
                <input type="text" id="inputBuscarNombre" class="form-control" placeholder="Buscar por nombre...">
              </div>
              <div class="col-md-4">
                <input type="text" id="inputBuscarEmail" class="form-control" placeholder="Buscar por email...">
              </div>
              <div class="col-md-4">
                <input type="text" id="inputBuscarTelefono" class="form-control" placeholder="Buscar por teléfono...">
              </div>
            </div>
          </div>
        </div>

        <!-- Vista de tarjetas -->
        <div id="vistaCards" class="row g-4" style="min-height: 400px;">
          <div class="col-12 text-center">
            <div class="spinner-border text-primary mt-5" role="status">
              <span class="visually-hidden">Cargando...</span>
            </div>
          </div>
        </div>

        <footer class="text-center mt-4 small text-muted">
          © 2025 Grupo Coyahue — Sistema de Inventario
        </footer>

      </div>
    </main>
  </div>

  <!-- Modal Detalle -->
  <div class="modal fade" id="modalDetalle" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-warning text-dark">
          <h5 class="modal-title">
            <i class="bi bi-truck me-2"></i>
            <span id="modalTitulo">Detalle de Proveedor</span>
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="modalContenido">
          <!-- Se llenará dinámicamente -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script type="module">
    import { API } from "/src/js/api.js";

    let proveedoresCache = [];

    function cargarSidebarUsuario() {
      const sidebar = document.getElementById("app-sidebar-user");
      if (!sidebar) return;

      sidebar.innerHTML = `
        <img src="/src/img/logo-coyahue.png" alt="Logo Coyahue" class="logo" />
        <nav>
          <a class="nav-link" href="panel.html">
            <i class="bi bi-house-door"></i> Inicio
          </a>
          <a class="nav-link" href="productos-usuario.html">
            <i class="bi bi-box-seam"></i> Productos
          </a>
          <a class="nav-link" href="categorias-usuario.html">
            <i class="bi bi-tags"></i> Categorías
          </a>
          <a class="nav-link active" href="proveedores-usuario.html">
            <i class="bi bi-truck"></i> Proveedores
          </a>
          <a class="nav-link" href="sucursales-usuario.html">
            <i class="bi bi-geo-alt"></i> Sucursales
          </a>
          <a class="nav-link" href="reportes-usuario.html">
            <i class="bi bi-graph-up"></i> Reportes
          </a>
          <a class="nav-link" href="/paginas/ajustes/ajustes.html">
            <i class="bi bi-gear"></i> Ajustes
          </a>
        </nav>
      `;
    }

    function cargarTopbarUsuario() {
      const topbar = document.getElementById("app-topbar");
      if (!topbar) return;

      const usuarioLog = localStorage.getItem("username") || "Usuario";

      topbar.innerHTML = `
        <div class="d-flex align-items-center gap-2">
          <button class="btn btn-link text-white d-lg-none p-0 me-2 menu-toggle" type="button">
            <i class="bi bi-list fs-3"></i>
          </button>
        </div>
        <div class="flex-grow-1"></div>
        <div class="d-flex align-items-center gap-3">
          <span id="btn-dark-toggle" class="toggle-dark" role="button">
            <i class="bi bi-moon-stars-fill" id="dark-icon"></i>
          </span>
          <div class="dropdown">
            <button class="btn btn-sm btn-outline-light dropdown-toggle user-area"
                    type="button" data-bs-toggle="dropdown">
              ${usuarioLog}
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item" href="/paginas/ajustes/ajustes.html">Ajustes</a></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item" onclick="window.cerrarSesion()">Cerrar sesión</a></li>
            </ul>
          </div>
        </div>
      `;
    }

    function normalizarLista(res) {
      if (Array.isArray(res)) return res;
      if (res && Array.isArray(res.results)) return res.results;
      return [];
    }

    function normalizarProveedor(p) {
      if (!p || typeof p !== "object") return {};
      return {
        id: p.id,
        nombre: p.nombre || p.nombre_fantasia || "",
        rut: p.rut || p.rut_empresa || "",
        telefono: p.telefono || p.fono || "",
        email: p.email || p.correo || "",
        contacto: p.contacto || "",
      };
    }

    async function cargarProveedores() {
      try {
        const res = await API.get("proveedores/");
        proveedoresCache = normalizarLista(res).map(normalizarProveedor);
        renderProveedores(proveedoresCache);
      } catch (err) {
        console.error("Error al cargar proveedores:", err);
        document.getElementById("vistaCards").innerHTML = `
          <div class="col-12 text-center text-danger">
            <i class="bi bi-exclamation-circle fs-1"></i>
            <p class="mt-2">No se pudieron cargar los proveedores.</p>
          </div>
        `;
      }
    }

    function aplicarFiltros() {
      const nombre = (document.getElementById("inputBuscarNombre")?.value || "").toLowerCase();
      const email = (document.getElementById("inputBuscarEmail")?.value || "").toLowerCase();
      const telefono = (document.getElementById("inputBuscarTelefono")?.value || "").toLowerCase();

      const filtrados = proveedoresCache.filter(p => {
        return (p.nombre || "").toLowerCase().includes(nombre) &&
               (p.email || "").toLowerCase().includes(email) &&
               (p.telefono || "").toLowerCase().includes(telefono);
      });

      renderProveedores(filtrados);
    }

    function renderProveedores(lista) {
      const cont = document.getElementById("vistaCards");
      if (!cont) return;

      if (!lista.length) {
        cont.innerHTML = `
          <div class="col-12 text-center text-muted">
            <i class="bi bi-inbox fs-1"></i>
            <p class="mt-2">No hay proveedores que coincidan con la búsqueda.</p>
          </div>
        `;
        return;
      }

      cont.innerHTML = "";

      lista.forEach(p => {
        const col = document.createElement("div");
        col.className = "col-md-6 col-lg-4";

        col.innerHTML = `
          <div class="card h-100 p-3" style="cursor:pointer;" onclick="verDetalle(${p.id})">
            <div class="d-flex align-items-start mb-3">
              <div class="me-3">
                <div style="width:50px;height:50px;border-radius:50%;background:#ffc107;display:flex;align-items:center;justify-content:center;">
                  <i class="bi bi-truck fs-4 text-white"></i>
                </div>
              </div>
              <div class="flex-grow-1">
                <h6 class="fw-bold mb-1">${p.nombre || "Sin nombre"}</h6>
                <small class="text-muted">ID: ${p.id}</small>
              </div>
            </div>
            <p class="small mb-1">
              <i class="bi bi-telephone text-warning me-2"></i>
              ${p.telefono || "Sin teléfono"}
            </p>
            <p class="small mb-0">
              <i class="bi bi-envelope text-warning me-2"></i>
              ${p.email || "Sin email"}
            </p>
          </div>
        `;

        cont.appendChild(col);
      });
    }

    window.verDetalle = async function(id) {
      const modal = new bootstrap.Modal(document.getElementById('modalDetalle'));
      const titulo = document.getElementById('modalTitulo');
      const contenido = document.getElementById('modalContenido');

      titulo.textContent = "Cargando...";
      contenido.innerHTML = '<div class="text-center"><div class="spinner-border text-warning"></div></div>';
      modal.show();

      try {
        const pRaw = await API.get(`proveedores/${id}/`);
        const p = normalizarProveedor(pRaw);

        titulo.textContent = p.nombre || "Sin nombre";

        contenido.innerHTML = `
          <div class="row">
            <div class="col-md-6">
              <p><strong>ID:</strong><br>${p.id}</p>
              <p><strong>Nombre:</strong><br>${p.nombre || "—"}</p>
              <p><strong>RUT:</strong><br>${p.rut || "—"}</p>
            </div>
            <div class="col-md-6">
              <p><strong>Teléfono:</strong><br>${p.telefono || "—"}</p>
              <p><strong>Email:</strong><br>${p.email || "—"}</p>
              <p><strong>Contacto:</strong><br>${p.contacto || "—"}</p>
            </div>
          </div>
        `;

      } catch (err) {
        console.error("Error al cargar detalle:", err);
        contenido.innerHTML = '<p class="text-danger">No se pudo cargar el detalle del proveedor.</p>';
      }
    };

    window.cerrarSesion = function() {
      localStorage.clear();
      window.location.href = "/paginas/login/login.html";
    };

    function configurarTema() {
      const body = document.body;
      const toggle = document.getElementById("btn-dark-toggle");
      const icon = document.getElementById("dark-icon");
      if (!toggle || !icon) return;

      const temaGuardado = localStorage.getItem("theme") || "light";
      if (temaGuardado === "dark") {
        body.classList.add("dark-mode");
        icon.classList.replace("bi-moon-stars-fill", "bi-brightness-high-fill");
      }

      toggle.addEventListener("click", () => {
        const esDark = body.classList.toggle("dark-mode");
        icon.classList.toggle("bi-moon-stars-fill", !esDark);
        icon.classList.toggle("bi-brightness-high-fill", esDark);
        localStorage.setItem("theme", esDark ? "dark" : "light");
      });
    }

    document.addEventListener("DOMContentLoaded", () => {
      cargarTopbarUsuario();
      cargarSidebarUsuario();
      configurarTema();
      cargarProveedores();

      document.getElementById("inputBuscarNombre")?.addEventListener("input", aplicarFiltros);
      document.getElementById("inputBuscarEmail")?.addEventListener("input", aplicarFiltros);
      document.getElementById("inputBuscarTelefono")?.addEventListener("input", aplicarFiltros);
    });
  </script>

</body>
</html>